name: Prebuild Docker image

on:
  push:
    branches:
    - master
    - cgranade/prebuild-docker # Temporarily enable on wrong branch to help test.

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - name: Docker Login
      uses: Azure/docker-login@v1
      with:
        # Container registry username
        username: ${{ secrets.ACR_SERVICE_PRINCIPAL_NAME }}
        # Container registry password
        password: ${{ secrets.ACR_SERVICE_PRINCIPAL_PASSWORD }}
        # Container registry server url
        login-server: ${{ secrets.ACR_REGISTRY }}
    - name: Build and push Docker image
      run: |
        $Now = [DateTime]::Now;
        $ImageTag = "{0}{1:d2}{2:d2}.{3:d2}{4:d2}.{5:d2}{6:d4}" -f $Now.Year, $Now.Month, $Now.Day, $Now.Hour, $Now.Minute, $Now.Second, $Now.Millisecond
        $ImageName = "samples"
        $RepoName = "public/quantum/samples"
        
        $LocalTag = "${ImageName}:${ImageTag}"
        $RemoteRepo = "${{ secrets.ACR_REGISTRY }}/${RepoName}/${ImageName}"

        docker build Build/images/samples --tag $LocalTag
        docker tag $LocalTag "${RemoteRepo}:${ImageTag}"
        docker push "${RemoteRepo}:${ImageTag}"
        docker tag $LocalTag "${RemoteRepo}:latest"
        docker push "${RemoteRepo}:latest"
      shell: pwsh
