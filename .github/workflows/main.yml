name: Prebuild Docker image

on:
  push:
    branches:
    - master
    - cgranade/prebuild-docker # Temporarily enable on wrong branch to help test.

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - name: Azure login
      uses: Azure/login@v1
      with:
        creds: ${{ secrets.ACR_CREDENTIALS }}
    - name: Docker Login
      run: az acr login -n msquantum
    - name: Build and push Docker image
      run: |
        $Now = [DateTime]::Now;
        $ImageTag = "{0}{1:d2}{2:d2}.{3:d2}{4:d2}.{5:d2}{6:d4}" -f $Now.Year, $Now.Month, $Now.Day, $Now.Hour, $Now.Minute, $Now.Second, $Now.Millisecond
        $RepoName = "public/quantum/samples"
        
        $LocalTag = "${RepoName}:${ImageTag}"
        $RemoteRepo = "${{ secrets.ACR_REGISTRY }}/${RepoName}"

        docker build Build/images/samples --tag $LocalTag
        docker tag $LocalTag "${RemoteRepo}:${ImageTag}"
        docker push "${RemoteRepo}:${ImageTag}"
        docker tag $LocalTag "${RemoteRepo}:latest"
        docker push "${RemoteRepo}:latest"
      shell: pwsh
